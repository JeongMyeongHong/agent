# Remote Deploy 스크립트 설정 가이드

## 📋 개요

`remote-deploy.sh`는 로컬에서 원격 서버로 SSH를 통해 배포하는 스크립트입니다.
서버 정보가 포함되므로 Git에 커밋하지 않습니다.

---

## 🚀 설정 방법

### 1. .env.prod 파일 준비

로컬에 `.env.prod` 파일을 생성하고 API 키 설정:

```bash
# .env.example을 복사
cp .env.example .env.prod

# 실제 값으로 수정
nano .env.prod
```

`.env.prod` 내용:
```env
OPENAI_API_KEY=sk-proj-실제키입력
BRAVE_API_KEY=실제키입력
DB_HOST=stock-invest-db
DB_PORT=5432
DB_NAME=stock_analysis
DB_USER=postgres
DB_PASSWORD=안전한비밀번호
```

### 2. remote-deploy.sh 설정 (이미 설정됨)

`remote-deploy.sh` 파일의 서버 정보 확인:

```bash
SERVER_USER="root"
SERVER_HOST="175.117.82.131"
SERVER_PORT="22"
```

### 3. 실행

```bash
./remote-deploy.sh
```

스크립트가 자동으로:
1. `.env.prod` 파일을 서버로 전송
2. GitHub에서 최신 코드 다운로드
3. Docker 이미지 빌드 및 실행

---

## 💡 사용 시나리오

### 시나리오 1: 기본 사용 (서버 정보 파일에 저장)

```bash
# 1. 파일 수정
nano remote-deploy.sh

# 서버 정보 입력
SERVER_USER="ubuntu"
SERVER_HOST="123.456.789.012"

# 2. 실행 (Enter만 누르면 기본값 사용)
./remote-deploy.sh
```

### 시나리오 2: 매번 서버 정보 입력

```bash
# 파일은 기본값 그대로 두고
# 실행 시마다 다른 정보 입력
./remote-deploy.sh

# 프롬프트에서 입력
서버 사용자명 [your-username]: ubuntu
서버 IP/도메인 [your-server-ip]: 123.456.789.012
SSH 포트 [22]: 22
```

### 시나리오 3: 여러 서버 관리

서버별로 스크립트 복사:

```bash
# Production
cp remote-deploy.sh.example remote-deploy-prod.sh
nano remote-deploy-prod.sh  # Production 서버 정보

# Staging
cp remote-deploy.sh.example remote-deploy-staging.sh
nano remote-deploy-staging.sh  # Staging 서버 정보

# 실행
./remote-deploy-prod.sh      # Production 배포
./remote-deploy-staging.sh   # Staging 배포
```

`.gitignore`에 추가:
```
remote-deploy-*.sh
```

---

## 🔑 SSH 키 설정 (비밀번호 없이 접속)

### 1. SSH 키 생성 (로컬)

```bash
ssh-keygen -t rsa -b 4096
# Enter 여러번 (기본 경로 사용)
```

### 2. 공개 키 서버에 복사

```bash
ssh-copy-id -p 22 ubuntu@your-server-ip
```

### 3. 테스트

```bash
ssh ubuntu@your-server-ip
# 비밀번호 없이 접속되면 성공!
```

이제 `remote-deploy.sh` 실행 시 비밀번호를 묻지 않습니다.

---

## 🔒 보안

### .gitignore에 포함됨

`remote-deploy.sh`는 자동으로 Git에서 제외됩니다:

```bash
# .gitignore
remote-deploy.sh
```

### 확인

```bash
git status
# remote-deploy.sh가 표시되지 않아야 함
```

### 실수로 커밋했다면

```bash
# 캐시에서 제거
git rm --cached remote-deploy.sh

# 커밋
git commit -m "Remove remote-deploy.sh from git"
```

---

## 🛠️ 고급 설정

### 다른 브랜치 배포

스크립트 수정:

```bash
# deploy.sh 다운로드 부분
curl -sSL https://raw.githubusercontent.com/JeongMyeongHong/agent/develop/deploy.sh -o /tmp/deploy.sh
                                                                    ^^^^^^^ 브랜치 변경
```

### 배포 전 백업

스크립트에 백업 명령 추가:

```bash
ssh -p $SERVER_PORT $SERVER_USER@$SERVER_HOST << 'ENDSSH'
set -e

# 배포 전 백업
echo "📦 백업 생성 중..."
cd /root/stock-invest 2>/dev/null || true
if [ -f "docker-compose.yml" ]; then
    docker exec stock-invest-db pg_dump -U postgres stock_analysis > /backups/backup-$(date +%Y%m%d-%H%M%S).sql
fi

# 나머지 배포 스크립트...
ENDSSH
```

### 배포 후 슬랙 알림

스크립트 마지막에 추가:

```bash
# 슬랙 웹훅 URL
SLACK_WEBHOOK="https://hooks.slack.com/services/YOUR/WEBHOOK/URL"

curl -X POST $SLACK_WEBHOOK \
  -H 'Content-Type: application/json' \
  -d "{\"text\": \"✅ 배포 완료: $SERVER_HOST\"}"
```

---

## 📝 예제

### 완전한 설정 예시

```bash
#!/bin/bash

# Production 서버 배포
SERVER_USER="ubuntu"
SERVER_HOST="stock-api.mycompany.com"
SERVER_PORT="22"

# Slack 알림
SLACK_WEBHOOK="https://hooks.slack.com/services/XXX/YYY/ZZZ"

echo "🌐 Production 배포"
echo "===================="
echo "서버: $SERVER_HOST"
echo ""

read -p "Production에 배포하시겠습니까? (yes/no): " confirm
if [[ ! $confirm == "yes" ]]; then
    echo "취소됨"
    exit 0
fi

# SSH 배포
ssh -p $SERVER_PORT $SERVER_USER@$SERVER_HOST << 'ENDSSH'
set -e

# 백업
echo "📦 백업..."
cd /root/stock-invest
docker exec stock-invest-db pg_dump -U postgres stock_analysis > /backups/backup-$(date +%Y%m%d-%H%M%S).sql

# 배포
echo "🚀 배포..."
curl -sSL https://raw.githubusercontent.com/JeongMyeongHong/agent/main/deploy.sh -o /tmp/deploy.sh
chmod +x /tmp/deploy.sh
/tmp/deploy.sh
ENDSSH

# Slack 알림
curl -X POST $SLACK_WEBHOOK \
  -H 'Content-Type: application/json' \
  -d "{\"text\": \"✅ Production 배포 완료\"}"

echo "✅ 완료!"
```

---

## 🚨 주의사항

1. **절대 Git에 커밋하지 마세요**
   - 서버 정보가 포함되어 있습니다
   - `.gitignore`에 포함되어 있는지 확인

2. **SSH 키 사용 권장**
   - 비밀번호 방식은 자동화에 부적합
   - SSH 키로 설정하세요

3. **Production 주의**
   - Production 배포 시 확인 프롬프트 추가
   - 백업 먼저 수행

---

## ✅ 체크리스트

- [ ] `remote-deploy.sh.example` 복사
- [ ] 서버 정보 입력
- [ ] 실행 권한 부여 (`chmod +x`)
- [ ] SSH 키 설정 (선택)
- [ ] Git에 커밋 안되는지 확인
- [ ] 테스트 실행

---

## 📚 관련 문서

- [DEPLOYMENT.md](DEPLOYMENT.md) - 전체 배포 가이드
- [배포가이드.md](배포가이드.md) - 빠른 참조
